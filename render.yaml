services:
  - type: web
    name: bacsystem
    env: php
    healthCheckPath: /robots.txt
    buildCommand: |
      php artisan optimize:clear
      composer install --no-interaction --prefer-dist --optimize-autoloader
      npm install && npm run build
    startCommand: |
      set -e
      # Start the web server immediately so health checks can pass
      php -S 0.0.0.0:$PORT -t public public/index.php & SERVER_PID=$!
      echo "Web server started on port $PORT (pid $SERVER_PID)"

      # Prepare app caches and storage symlink without blocking the server
      php artisan optimize:clear || true
      php artisan config:cache || true
      php artisan route:cache || true
      php artisan view:cache || true
      php artisan storage:link || true

      # Run migrations with retries; do not block health checks
      RETRIES=${MIGRATE_RETRIES:-10}
      SLEEP=${MIGRATE_SLEEP:-5}
      if [ "${SKIP_AUTO_MIGRATE:-false}" != "true" ]; then
        echo "Attempting database migrations..."
        for i in $(seq 1 "$RETRIES"); do
          php artisan migrate --force && break || true
          echo "Migration attempt $i failed; retrying in $SLEEP seconds..."
          sleep "$SLEEP"
        done
      fi

      # Optional seeding
      if [ "${RUN_DB_SEED:-false}" = "true" ]; then
        php artisan db:seed --force || true
      fi

      # Keep the process attached to the web server
      wait "$SERVER_PID"
    envVars:
      - key: APP_ENV
        value: production
      - key: APP_DEBUG
        value: false
      - key: APP_KEY
        sync: false
      - key: APP_URL
        sync: false
      - key: DB_CONNECTION
        value: pgsql
      - key: DB_HOST
        sync: false
      - key: DB_PORT
        sync: false
      - key: DB_DATABASE
        sync: false
      - key: DB_USERNAME
        sync: false
      - key: DB_PASSWORD
        sync: false
      - key: MIGRATE_RETRIES
        value: 10
      - key: MIGRATE_SLEEP
        value: 5
      - key: SKIP_AUTO_MIGRATE
        value: false
      - key: RUN_DB_SEED
        value: false
      - key: MAIL_MAILER
        value: smtp
      - key: MAIL_HOST
        value: smtp-relay.brevo.com
      - key: MAIL_PORT
        value: 587
      - key: MAIL_USERNAME
        sync: false
      - key: MAIL_PASSWORD
        sync: false
      - key: MAIL_ENCRYPTION
        value: tls
      - key: MAIL_FROM_ADDRESS
        sync: false
      - key: MAIL_FROM_NAME
        value: "BAC System"